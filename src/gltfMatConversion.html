<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <title>glTF: Convert Specular/Glossiness Material Parameters to Metallic/Roughness</title>
        <meta charset="utf-8"></meta>
        <style>
            input[type=text] {
                width:50%;
            }
        </style>
<body>
        <label for="diffuse">Diffuse Texture: "./runner-game/living-models/</label>
        <input type="text" id="diffuse" name="diffuse">
        "<br><br>
        <label for="shininess">Shininess: (eg: "0.01")</label>
        <input type="text" id="shininess" name="shininess" value="0.01"><br><br>
        <label for="specular">Specular Colour: (eg: "0.5,0.5,0.5")</label>
        <input type="text" id="specular" name="specular" value="0.5,0.5,0.5"><br><br>
        <button id="submit">Submit</button><br><br>
        <p id="myOutput"></p>
        <canvas id="myCanvas"></canvas>
<script src="../lib/three.js"></script>
<script src="gltfMatConversion.js"></script>
<script>
    document.getElementById("submit").onclick = function() {
        // No error checking!!!!
        const shininess = document.getElementById("shininess").value;
        const specText = document.getElementById("specular").value.split(",");
        const specular = new THREE.Color(specText[0], specText[1], specText[2]);

        const diffuse = "./runner-game/living-models/" + document.getElementById("diffuse").value;
        const loader = new THREE.ImageLoader();
        loader.load(diffuse, function(img) {
                // Put the image on the canvas so we can analyse the pixels
                const canvas = document.getElementById( 'myCanvas' );
                const context = canvas.getContext( '2d' );
                context.width = canvas.width = img.width;
                context.height = canvas.height = img.height;
                context.drawImage( img, 0, 0);

                // Average perceivedBrightness over all pixels
                pixels = context.getImageData(0, 0, context.width, context.height);
                let diffBrightSum = 0;
                let n = 0;
                //let skipped = 0;
                for (let i = 0; i < pixels.data.length; i += 4) {
                    if (pixels.data[i + 3] < (255/2) ||
                            pixels.data[i] == 0 && pixels.data[i + 1] == 0 && pixels.data[i+2] == 0) {
                        //skipped ++;
                        continue; //skip pixels that are too transparent or full black
                    }
                    const colr = new THREE.Color(pixels.data[i] / 255.,
                                                 pixels.data[i+1] / 255.,
                                                 pixels.data[i+2] / 255.);
                    diffBrightSum += colr.getPerceivedBrightness();
                    n++;
                }
                //console.log(skipped);
                const diffBright = diffBrightSum / n;

                // Calculate metallic and roughness. Prepare output.
                const roughness = getRoughnessofSpecularGlossinessMat(shininess);
                const metallic = getMetallicofSpecularGlossinessMat(diffBright, specular);
                let output = 'Averaged diffuse texture brightness: ' + diffBright +
                    '<br><br><b>Output (add to pbrMetallicRoughness):</b><br>' +
                    '"metallicFactor": ' + metallic + ',<br>"roughnessFactor": ' + roughness;

                const outputSlot = document.getElementById( "myOutput" );
                outputSlot.innerHTML = output;
            },
            undefined,
            function() {console.error('error'); });


    };
</script>


</body></html>